<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>樱兰学院咖啡谷</title>
  <style>
    :root{
      --dock-gap: 12px;
      --dock-h: 86px;        /* 预估高度，用来给 body 留底部空间 */
      --dock-margin: 12px;
      --filter-gap: 8px;
    }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;
      margin:16px;line-height:1.5;
      padding-bottom: calc(var(--dock-h) + var(--dock-margin) * 2 + 16px);
    }
    h1{font-size:22px;margin:0 0 8px;font-weight:900}
    .hint{color:#555;font-size:13px;margin:0 0 16px}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:10px;vertical-align:top}
    th{background:#f7f7f7;text-align:left;font-weight:700;white-space:nowrap}

    .imgbtn{border:0;background:transparent;padding:0;cursor:pointer}
    .imgbtn:focus{outline:2px solid #999;outline-offset:3px;border-radius:12px}
    img.goodsimg{width:180px;max-width:100%;height:auto;border-radius:12px;border:1px solid #eee;display:block}

    .zh{font-size:16px;font-weight:900}
    .ja{color:#666;font-size:12px;margin-top:2px}
    .meta{color:#666;font-size:12px;margin-top:6px}
    .warn{display:none;margin-top:6px;font-size:12px;color:#8a4b00;background:#fff7e6;border:1px solid #ffe2b8;padding:6px 8px;border-radius:10px}
    .warn.show{display:block}

    .num{width:96px}
    .right{text-align:right;white-space:nowrap}

    .btn{padding:8px 12px;border:1px solid #ccc;border-radius:10px;background:#fff;cursor:pointer}
    .btn:hover{background:#f4f4f4}

    .label{display:none;color:#666;font-size:12px;margin-right:8px}
    .unit{color:#666;font-size:12px;margin-left:6px}

    /* ====== 移动端：卡片布局 ====== */
    @media (max-width: 720px){
      :root{ --dock-h: 118px; } /* 移动端 dock 更高一些 */
      body{margin:12px}
      table{border:0}
      thead{display:none}
      tbody{display:block}

      tr{
        display:grid;
        grid-template-columns: 132px 1fr;
        grid-template-areas:
          "img name"
          "img price"
          "img qty"
          "img sub";
        border:1px solid #ddd;
        border-radius:14px;
        margin-bottom:12px;
        overflow:hidden;
        background:#fff;
      }
      td{border:0;padding:10px}
      td:nth-child(1){grid-area:img;border-right:1px solid #eee;display:flex;align-items:center;justify-content:center}
      td:nth-child(2){grid-area:name}
      td:nth-child(5){grid-area:price}
      td:nth-child(6){grid-area:qty}
      td:nth-child(7){grid-area:sub}

      /* 小屏隐藏“类型/限购列”（限购信息在 meta 里仍显示） */
      td:nth-child(3), td:nth-child(4){display:none}

      img.goodsimg{width:110px}
      .right{text-align:left}
      .label{display:inline-block}
      .num{width:120px;font-size:16px}
    }

    /* ====== 图片放大 ====== */
    .lightbox{position:fixed;inset:0;display:none;z-index:9999;}
    .lightbox.open{display:block}
    .lb-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.72);}
    .lb-dialog{
      position:relative;margin:5vh auto;
      width:min(92vw, 980px);height:min(90vh, 900px);
      display:flex;align-items:center;justify-content:center;
      pointer-events:none;
    }
    .lb-inner{pointer-events:auto;position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
    .lb-img{max-width:100%;max-height:100%;border-radius:14px;background:#111;border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 40px rgba(0,0,0,.5);}
    .lb-close{
      position:absolute;top:10px;right:10px;width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.35);color:#fff;font-size:22px;cursor:pointer;
    }
    .lb-close:hover{background:rgba(0,0,0,.55)}
    .lb-cap{
      position:absolute;left:12px;right:12px;bottom:10px;color:#fff;font-size:13px;
      text-align:center;text-shadow:0 2px 10px rgba(0,0,0,.8);opacity:.9;pointer-events:none;
    }

    /* ====== 底部悬浮结算条 Dock ====== */
    .dock{
      position:fixed;
      left:var(--dock-margin);
      right:var(--dock-margin);
      bottom:var(--dock-margin);
      z-index:9996;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--dock-gap);
      flex-wrap:wrap;
      padding:12px 12px;
      background:rgba(255,255,255,.96);
      border:1px solid #e8e8e8;
      border-radius:18px;
      box-shadow:0 10px 28px rgba(0,0,0,.10);
      backdrop-filter: blur(6px);
    }
    .dock .left, .dock .mid, .dock .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .dock .right{
      margin-left:auto;
      justify-content:flex-end;
    }
    .tickets{font-size:14px;font-weight:900;color:#222}
    .total{font-size:18px;font-weight:900}
    .ticketInput{display:flex;gap:8px;align-items:center;font-size:14px;color:#222;font-weight:800}
    .ticketInput input{width:96px;padding:8px 10px;border:1px solid #ccc;border-radius:12px;font-size:14px}

    @media (max-width:720px){
      .dock{padding:10px}
      .ticketInput input{width:88px}
      .total{font-size:16px}
    }

    /* ====== 右侧悬浮筛选（上移避免挡住 Dock） ====== */
    .filterbar{
      position:fixed;
      right:12px;
      bottom: calc(var(--dock-margin) + var(--dock-h) + 12px);
      z-index:9997;
      display:flex;flex-direction:column;gap:var(--filter-gap);
    }
    .fbtn{
      border:1px solid #ccc;background:#fff;border-radius:14px;
      padding:10px 12px;cursor:pointer;font-weight:900;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      min-width:92px;text-align:center;
    }
    .fbtn.active{border-color:#333}
    .fnote{
      position:fixed;
      right:12px;
      bottom: calc(var(--dock-margin) + var(--dock-h) + 12px + 3 * (44px + var(--filter-gap)) + 8px);
      z-index:9997;
      font-size:12px;color:#666;background:#fff;border:1px solid #eee;
      padding:8px 10px;border-radius:12px;max-width:170px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    @media (max-width:720px){
      .filterbar{right:10px}
      .fnote{display:none;}
    }
  </style>
</head>

<body>
  <h1><strong>樱兰学院咖啡谷</strong></h1>
  <p class="hint">欢迎使用自助下单系统，联系微信咨询或获取报价。</p>

  <table id="goodsTable">
    <thead>
      <tr>
        <th>图片</th>
        <th>商品名</th>
        <th>商品类型</th>
        <th class="right">每张票限购</th>
        <th class="right">单价</th>
        <th class="right">希望数量</th>
        <th class="right">小计</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 右侧筛选 -->
  <div class="fnote">筛选只用于查看，不会清空已填数量。</div>
  <div class="filterbar" aria-label="筛选">
    <button class="fbtn active" data-filter="all" type="button">全部</button>
    <button class="fbtn" data-filter="blind" type="button">盲抽</button>
    <button class="fbtn" data-filter="single" type="button">单领</button>
  </div>

  <!-- 底部悬浮 Dock -->
  <div class="dock" role="region" aria-label="结算栏">
    <div class="left">
      <button class="btn" id="resetBtn" type="button">清空数量</button>
    </div>

    <div class="mid">
      <div class="ticketInput">
        当前票数：
        <input id="currentTickets" type="number" min="0" step="1" value="0" inputmode="numeric" />
      </div>
    </div>

    <div class="right">
      <div class="tickets">至少需要票数：<span id="ticketsNeeded">0</span></div>
      <div class="total">总价：<span id="grandTotal">¥0</span></div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <div class="lb-backdrop" id="lbBackdrop"></div>
    <div class="lb-dialog" role="dialog" aria-modal="true">
      <div class="lb-inner">
        <button class="lb-close" type="button" id="lbClose" aria-label="关闭">×</button>
        <img id="lbImg" class="lb-img" alt="" />
        <div id="lbCap" class="lb-cap"></div>
      </div>
    </div>
  </div>

<script>
  const IMG_BASE = "../assets/images/tokyo/goods/";
  const yen = (n)=> new Intl.NumberFormat("ja-JP").format(n);

  const items = [
    // 单领：立牌
    {id:"stand_haruhi", img:"goods-20251224-1.png", zh:"亚克力立牌｜藤冈春日", ja:"アクリルスタンド｜藤岡 ハルヒ", cat:"single", limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"stand_tamaki", img:"goods-20251224-1.png", zh:"亚克力立牌｜须王环",   ja:"アクリルスタンド｜須王 環",     cat:"single", limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"stand_kyoya",  img:"goods-20251224-1.png", zh:"亚克力立牌｜凤镜夜",   ja:"アクリルスタンド｜鳳 鏡夜",     cat:"single", limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"stand_hikaru", img:"goods-20251224-1.png", zh:"亚克力立牌｜常陆院光", ja:"アクリルスタンド｜常陸院 光",   cat:"single", limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"stand_kaoru",  img:"goods-20251224-1.png", zh:"亚克力立牌｜常陆院馨", ja:"アクリルスタンド｜常陸院 馨",   cat:"single", limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"stand_honey",  img:"goods-20251224-1.png", zh:"亚克力立牌｜埴之冢光邦（Honey）", ja:"アクリルスタンド｜埴之塚 光邦", cat:"single", limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"stand_mori",   img:"goods-20251224-1.png", zh:"亚克力立牌｜铦之冢崇（Mori）",   ja:"アクリルスタンド｜銛之塚 崇",   cat:"single", limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},

    // 盲抽：标记钥匙扣（单抽+整套累计）
    {id:"mejirushi_single", img:"goods-20251224-2.png", zh:"盲抽 标记亚克力钥匙扣（单抽）", ja:"トレーディングめじるしアクキー（単品）", cat:"blind",
      limitPiecesPerTicket:20, limitDisplay:"20个", price:660,  groupId:"mejirushi", unitsPerQty:1,  inputUnit:"个"},
    {id:"mejirushi_set",    img:"goods-20251224-2.png", zh:"盲抽 标记亚克力钥匙扣（整套）", ja:"トレーディングめじるしアクキー（コンプリートセット）", cat:"blind",
      limitPiecesPerTicket:20, limitDisplay:"2套",  price:6600, groupId:"mejirushi", unitsPerQty:10, inputUnit:"套"},

    // 盲抽：镭射吧唧（单抽+整套累计）
    {id:"badge_single", img:"goods-20251224-3.png", zh:"盲抽 镭射徽章（单抽）", ja:"トレーディングホログラム缶バッジ（単品）", cat:"blind",
      limitPiecesPerTicket:14, limitDisplay:"14个", price:550,  groupId:"badge", unitsPerQty:1, inputUnit:"个"},
    {id:"badge_set",    img:"goods-20251224-3.png", zh:"盲抽 镭射徽章（整套）", ja:"トレーディングホログラム缶バッジ（コンプリートセット）", cat:"blind",
      limitPiecesPerTicket:14, limitDisplay:"2盒",  price:3850, groupId:"badge", unitsPerQty:7, inputUnit:"盒"},

    // 盲抽：亚克力杯垫（单抽+整套累计）
    {id:"coaster_single", img:"goods-20251224-4.png", zh:"盲抽 亚克力杯垫（单抽）", ja:"トレーディングアクリルコースター（単品）", cat:"blind",
      limitPiecesPerTicket:30, limitDisplay:"30个", price:770,   groupId:"coaster", unitsPerQty:1,  inputUnit:"个"},
    {id:"coaster_set",    img:"goods-20251224-4.png", zh:"盲抽 亚克力杯垫（整套）", ja:"トレーディングアクリルコースター（コンプリートセット）", cat:"blind",
      limitPiecesPerTicket:30, limitDisplay:"2盒",  price:11550, groupId:"coaster", unitsPerQty:15, inputUnit:"盒"},

    // 单领
    {id:"file2", img:"goods-20251224-5.png", zh:"透明文件夹 2枚套装", ja:"クリアファイル2枚セット", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3套", price:880, groupId:null, unitsPerQty:1, inputUnit:"套"},

    {id:"slide_a", img:"goods-20251224-6.png", zh:"滑动亚克力钥匙扣 A（春日&环）", ja:"スライドアクキー A（ハルヒ&環）", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:1100, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"slide_b", img:"goods-20251224-6.png", zh:"滑动亚克力钥匙扣 B（环&镜夜）", ja:"スライドアクキー B（環&鏡夜）", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:1100, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"slide_c", img:"goods-20251224-6.png", zh:"滑动亚克力钥匙扣 C（光&馨）", ja:"スライドアクキー C（光&馨）", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:1100, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"slide_d", img:"goods-20251224-6.png", zh:"滑动亚克力钥匙扣 D（Honey&Mori）",ja:"スライドアクキー D（ハニー&モリ）", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:1100, groupId:null, unitsPerQty:1, inputUnit:"个"},

    // 盲抽：亚克力卡（单抽+整套累计）
    {id:"acard_single", img:"goods-20251224-7.png", zh:"盲抽 亚克力卡（单抽）", ja:"トレーディングアクリルカード（単品）", cat:"blind",
      limitPiecesPerTicket:14, limitDisplay:"14个", price:660,  groupId:"acard", unitsPerQty:1, inputUnit:"个"},
    {id:"acard_set",    img:"goods-20251224-7.png", zh:"盲抽 亚克力卡（整套）", ja:"トレーディングアクリルカード（コンプリートセット）", cat:"blind",
      limitPiecesPerTicket:14, limitDisplay:"2盒",  price:4620, groupId:"acard", unitsPerQty:7, inputUnit:"盒"},

    // 单领
    {id:"pouch", img:"goods-20251224-8.png", zh:"抽绳束口袋", ja:"巾着", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:1650, groupId:null, unitsPerQty:1, inputUnit:"个"},

    // 盲抽：透明卡（单抽+整套累计）
    {id:"ccard_single", img:"goods-20251224-9.png", zh:"盲抽 透明卡收藏（单抽）", ja:"トレーディングクリアカードコレクション（単品）", cat:"blind",
      limitPiecesPerTicket:24, limitDisplay:"24个", price:660,  groupId:"ccard", unitsPerQty:1,  inputUnit:"个"},
    {id:"ccard_set",    img:"goods-20251224-9.png", zh:"盲抽 透明卡收藏（整套）", ja:"トレーディングクリアカードコレクション（コンプリートセット）", cat:"blind",
      limitPiecesPerTicket:24, limitDisplay:"2盒",  price:7920, groupId:"ccard", unitsPerQty:12, inputUnit:"盒"},

    // 单领
    {id:"postcard", img:"goods-20251224-10.png", zh:"明信片套装（12张）", ja:"ポストカードセット", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3套", price:1540, groupId:null, unitsPerQty:1, inputUnit:"套"},
    {id:"shikishi", img:"goods-20251224-11.png", zh:"亚克力迷你色纸板", ja:"アクリルミニ色紙", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:2200, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"sticker",  img:"goods-20251224-12.png", zh:"证件照贴纸", ja:"証明写真シール", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3份", price:880, groupId:null, unitsPerQty:1, inputUnit:"份"},

    {id:"photo_a", img:"goods-20251224-13.png", zh:"亚克力相片夹 A（钥匙扣款）", ja:"アクリルフォトケース A（キーホルダー）", cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:1210, groupId:null, unitsPerQty:1, inputUnit:"个"},
    {id:"photo_b", img:"goods-20251224-13.png", zh:"亚克力相片夹 B（支架款）",   ja:"アクリルフォトケース B（スタンド）",     cat:"single",
      limitPiecesPerTicket:3, limitDisplay:"3个", price:2310, groupId:null, unitsPerQty:1, inputUnit:"个"},

    // 盲抽：扭蛋
    {id:"gacha", img:"goods-20251224-15.png", zh:"盲抽 亚克力旅馆钥匙牌钥匙扣（扭蛋）", ja:"アクリルモーテルキーホルダー（カプセルトイ）", cat:"blind",
      limitPiecesPerTicket:3, limitDisplay:"3回", price:660, groupId:null, unitsPerQty:1, inputUnit:"回"},
  ];

  const tbody = document.querySelector("#goodsTable tbody");
  const grandTotalEl = document.getElementById("grandTotal");
  const ticketsNeededEl = document.getElementById("ticketsNeeded");
  const currentTicketsEl = document.getElementById("currentTickets");

  // Lightbox
  const lb = document.getElementById("lightbox");
  const lbImg = document.getElementById("lbImg");
  const lbCap = document.getElementById("lbCap");
  const lbBackdrop = document.getElementById("lbBackdrop");
  const lbClose = document.getElementById("lbClose");

  function openLightbox(src, cap){
    lbImg.src = src;
    lbImg.alt = cap || "预览";
    lbCap.textContent = cap || "";
    lb.classList.add("open");
    lb.setAttribute("aria-hidden","false");
  }
  function closeLightbox(){
    lb.classList.remove("open");
    lb.setAttribute("aria-hidden","true");
    lbImg.src = "";
    lbCap.textContent = "";
  }
  lbBackdrop.addEventListener("click", closeLightbox);
  lbClose.addEventListener("click", closeLightbox);
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && lb.classList.contains("open")) closeLightbox();
  });

  function render(){
    tbody.innerHTML = "";
    items.forEach((it)=>{
      const imgSrc = IMG_BASE + it.img;
      const tr = document.createElement("tr");
      tr.dataset.id = it.id;
      tr.dataset.cat = it.cat;

      const groupNote = it.groupId ? "（与同系列单抽/整套合计限购）" : "";

      tr.innerHTML = `
        <td>
          <button class="imgbtn" type="button" aria-label="点击放大图片">
            <img class="goodsimg" src="${imgSrc}" alt="${it.zh}">
          </button>
        </td>
        <td>
          <div class="zh">${it.zh}</div>
          <div class="ja">${it.ja}</div>
          <div class="meta">每张票限购：${it.limitDisplay} ${groupNote}</div>
          <div class="warn" data-warn-for="${it.id}"></div>
        </td>
        <td>${it.cat === "blind" ? "盲抽" : "单领"}</td>
        <td class="right">${it.limitDisplay}</td>
        <td class="right"><span class="label">单价</span>¥${yen(it.price)}</td>
        <td class="right">
          <span class="label">数量</span>
          <input class="num" type="number" min="0" step="1" value="0" inputmode="numeric" />
          <span class="unit">${it.inputUnit || ""}</span>
        </td>
        <td class="right"><span class="label">小计</span><span class="subtotal">¥0</span></td>
      `;

      tr.querySelector(".imgbtn").addEventListener("click", ()=> openLightbox(imgSrc, it.zh));

      const input = tr.querySelector("input");
      const subtotalEl = tr.querySelector(".subtotal");

      function recalcRow(){
        let qty = parseInt(input.value || "0", 10);
        if (Number.isNaN(qty) || qty < 0) qty = 0;
        input.value = qty;

        subtotalEl.textContent = "¥" + yen(qty * it.price);
        recalcAll();
      }

      input.addEventListener("input", recalcRow);
      input.addEventListener("change", recalcRow);

      tbody.appendChild(tr);
    });

    recalcAll();
  }

  function getQtyById(id){
    const tr = tbody.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
    if(!tr) return 0;
    const v = parseInt(tr.querySelector("input").value || "0", 10);
    return Number.isNaN(v) ? 0 : Math.max(0, v);
  }

  function clearAllWarnings(){
    tbody.querySelectorAll(".warn").forEach(w=>{
      w.textContent = "";
      w.classList.remove("show");
    });
  }

  function showWarnForIds(ids, msg){
    ids.forEach(id=>{
      const tr = tbody.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
      if(!tr) return;
      const w = tr.querySelector(`.warn[data-warn-for="${CSS.escape(id)}"]`);
      if(!w) return;
      w.textContent = msg;
      w.classList.add("show");
    });
  }

  function recalcAll(){
    // 总价
    let total = 0;
    items.forEach(it=>{
      const qty = getQtyById(it.id);
      total += qty * it.price;
    });
    grandTotalEl.textContent = "¥" + yen(total);

    // 当前票数
    let currentTickets = parseInt(currentTicketsEl.value || "0", 10);
    if (Number.isNaN(currentTickets) || currentTickets < 0) currentTickets = 0;

    // 约束（用于：至少需要票数 + 超出当前票数提示）
    // key -> {limitPieces, pieces, rowIds}
    const constraints = new Map();

    items.forEach(it=>{
      if(typeof it.limitPiecesPerTicket !== "number") return;
      const qty = getQtyById(it.id);
      const pieces = qty * (it.unitsPerQty || 1);
      if(pieces <= 0) return;

      const key = it.groupId ? `group:${it.groupId}` : `item:${it.id}`;
      if(!constraints.has(key)){
        constraints.set(key, {limitPieces: it.limitPiecesPerTicket, pieces: 0, rowIds: []});
      }
      const c = constraints.get(key);
      c.pieces += pieces;
      c.limitPieces = Math.max(c.limitPieces, it.limitPiecesPerTicket);
      c.rowIds.push(it.id);
    });

    // 至少需要票数
    let ticketsNeeded = 0;
    constraints.forEach(c=>{
      const need = Math.ceil(c.pieces / c.limitPieces);
      ticketsNeeded = Math.max(ticketsNeeded, need);
    });
    ticketsNeededEl.textContent = String(ticketsNeeded);

    // 超出“当前票数”提示（不展示折算细节）
    clearAllWarnings();
    if(currentTickets > 0){
      constraints.forEach(c=>{
        const need = Math.ceil(c.pieces / c.limitPieces);
        if(need > currentTickets){
          const msg = `按当前票数（${currentTickets}张）至少需要 ${need} 张票`;
          showWarnForIds(c.rowIds, msg);
        }
      });
    }
  }

  // 清空
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    tbody.querySelectorAll("input").forEach(i=> i.value = 0);
    tbody.querySelectorAll(".subtotal").forEach(s=> s.textContent = "¥0");
    recalcAll();
  });

  // 当前票数变更
  currentTicketsEl.addEventListener("input", recalcAll);
  currentTicketsEl.addEventListener("change", recalcAll);

  // 筛选：不重绘，只隐藏/显示行 => 不丢数量
  function setFilter(filter){
    document.querySelectorAll(".fbtn").forEach(b=> b.classList.toggle("active", b.dataset.filter === filter));
    tbody.querySelectorAll("tr").forEach(tr=>{
      const cat = tr.dataset.cat;
      tr.style.display =
        (filter === "all") ? "" :
        (filter === "blind" && cat === "blind") ? "" :
        (filter === "single" && cat === "single") ? "" : "none";
    });
  }
  document.querySelectorAll(".fbtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setFilter(btn.dataset.filter));
  });

  render();
  setFilter("all");
</script>
</body>
</html>
